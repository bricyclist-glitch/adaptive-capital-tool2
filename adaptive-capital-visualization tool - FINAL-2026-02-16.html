<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adaptive Capital System - Relational Analysis</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e27;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 30px 40px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            font-size: 32px;
            color: white;
            margin-bottom: 8px;
        }

        .header p {
            color: rgba(255,255,255,0.8);
            font-size: 15px;
        }

        .main-container {
            display: grid;
            grid-template-columns: 450px 1fr;
            min-height: calc(100vh - 120px);
        }

        /* INPUT PANEL */
        .input-panel {
            background: #1a1f3a;
            padding: 30px;
            border-right: 2px solid #2a3555;
            overflow-y: auto;
            max-height: calc(100vh - 120px);
        }

        .context-box {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .context-box h3 {
            font-size: 14px;
            color: #667eea;
            margin-bottom: 8px;
        }

        .context-box p {
            font-size: 13px;
            color: #b0b0b0;
            line-height: 1.5;
        }

        .section {
            margin-bottom: 32px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #2a3555;
        }

        .section-icon {
            font-size: 24px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
        }

        .section-subtitle {
            font-size: 12px;
            color: #888;
            margin-top: 2px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            font-size: 13px;
            font-weight: 600;
            color: #b0b0b0;
            margin-bottom: 8px;
            display: block;
        }

        .input-hint {
            font-size: 11px;
            color: #666;
            font-style: italic;
            margin-top: 4px;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            background: #0a0e27;
            border: 1px solid #2a3555;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 14px;
            transition: all 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        textarea {
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        .slider-container {
            margin: 12px 0;
        }

        .slider {
            width: 100%;
            height: 6px;
            background: #2a3555;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #667eea;
            cursor: pointer;
            border-radius: 50%;
        }

        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #667eea;
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: #666;
        }

        .phase-indicator-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 12px;
        }

        .phase-option {
            padding: 12px;
            background: #0a0e27;
            border: 2px solid #2a3555;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .phase-option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .phase-option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.2);
        }

        .phase-option-label {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .phase-option-desc {
            font-size: 10px;
            color: #888;
        }

        .analyze-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        /* Color-coded sections */
        .enterprise-section label,
        .enterprise-section .input-label,
        .enterprise-section .input-hint,
        .enterprise-section .slider-labels span,
        .enterprise-section .phase-option-label,
        .enterprise-section .phase-option-desc,
        .enterprise-section .section-subtitle {
            color: #1abc9c !important;
        }

        .portfolio-section label,
        .portfolio-section .input-label,
        .portfolio-section .input-hint,
        .portfolio-section .slider-labels span,
        .portfolio-section .phase-option-label,
        .portfolio-section .phase-option-desc,
        .portfolio-section .section-subtitle {
            color: #3498db !important;
        }

        .market-section label,
        .market-section .input-label,
        .market-section .input-hint,
        .market-section .slider-labels span,
        .market-section .phase-option-label,
        .market-section .phase-option-desc,
        .market-section .section-subtitle {
            color: #e74c3c !important;
        }

        .enterprise-section .phase-option {
            border-color: rgba(26, 188, 156, 0.3);
        }

        .enterprise-section .phase-option:hover,
        .enterprise-section .phase-option.selected {
            border-color: #1abc9c;
            background: rgba(26, 188, 156, 0.2);
        }

        .portfolio-section .phase-option {
            border-color: rgba(52, 152, 219, 0.3);
        }

        .portfolio-section .phase-option:hover,
        .portfolio-section .phase-option.selected {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.2);
        }

        .market-section .phase-option {
            border-color: rgba(231, 76, 60, 0.3);
        }

        .market-section .phase-option:hover,
        .market-section .phase-option.selected {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.2);
        }

        /* Pause button styling */
        .pause-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 6px 12px;
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid #667eea;
            border-radius: 6px;
            color: #667eea;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 10;
        }

        .pause-btn:hover {
            background: rgba(102, 126, 234, 0.4);
            transform: translateY(-1px);
        }

        .pause-btn.paused {
            background: rgba(231, 76, 60, 0.2);
            border-color: #e74c3c;
            color: #e74c3c;
        }

        /* ANALYSIS PANEL */
        .analysis-panel {
            background: #0a0e27;
            padding: 30px;
            overflow-y: auto;
            max-height: calc(100vh - 120px);
        }

        .analysis-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }

        .analysis-empty-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* PHASE RELATIONSHIP MAP */
        .phase-map-container {
            background: #1a1f3a;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid #2a3555;
        }

        .phase-map-title {
            font-size: 20px;
            font-weight: 700;
            color: #e0e0e0;
            margin-bottom: 24px;
            text-align: center;
        }

        #phaseCanvas {
            width: 100%;
            height: 500px;
            background: radial-gradient(circle at center, #0a0e27 0%, #000000 100%);
            border-radius: 12px;
        }

        /* INSIGHTS GRID */
        .insights-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .insight-card {
            background: #1a1f3a;
            border-radius: 12px;
            padding: 24px;
            border: 2px solid #2a3555;
            transition: all 0.3s;
        }

        .insight-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
        }

        .insight-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .insight-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .insight-title {
            font-size: 16px;
            font-weight: 700;
            color: #e0e0e0;
        }

        .insight-content {
            font-size: 14px;
            color: #b0b0b0;
            line-height: 1.6;
        }

        .insight-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #2a3555;
        }

        .insight-metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-size: 13px;
            color: #888;
        }

        .metric-value {
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
        }

        /* CAPITAL BEHAVIOR RECOMMENDATIONS */
        .capital-behavior {
            background: linear-gradient(135deg, #1a1f3a 0%, #252b45 100%);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid #667eea;
            position: relative;
        }

        .capital-behavior-title {
            font-size: 22px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 20px;
        }

        .behavior-timeline {
            position: relative;
            padding-left: 30px;
        }

        .behavior-timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, #1abc9c 0%, #3498db 25%, #e74c3c 50%, #f1c40f 75%, #1abc9c 100%);
        }

        .behavior-phase {
            margin-bottom: 24px;
            position: relative;
        }

        .behavior-phase::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #667eea;
            border: 3px solid #0a0e27;
        }

        .behavior-phase-name {
            font-size: 14px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }

        .behavior-phase-action {
            font-size: 13px;
            color: #b0b0b0;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .behavior-terms {
            background: rgba(102, 126, 234, 0.1);
            border-left: 3px solid #667eea;
            padding: 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #a0a0a0;
            margin-top: 8px;
        }

        /* CROSS-SCALE DYNAMICS */
        .dynamics-matrix {
            background: #1a1f3a;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            position: relative;
        }

        .dynamics-title {
            font-size: 18px;
            font-weight: 700;
            color: #e0e0e0;
            margin-bottom: 20px;
        }

        .dynamics-grid {
            display: grid;
            grid-template-columns: 150px repeat(2, 1fr);
            gap: 2px;
            background: #2a3555;
            border-radius: 8px;
            overflow: hidden;
        }

        .dynamics-cell {
            background: #0a0e27;
            padding: 16px 12px;
            text-align: center;
            font-size: 12px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .dynamics-cell.header {
            background: #252b45;
            font-weight: 700;
            color: #667eea;
            font-size: 11px;
            line-height: 1.3;
        }

        .dynamics-cell.label {
            background: #252b45;
            font-weight: 600;
            color: #888;
            text-align: center;
            font-size: 11px;
            line-height: 1.3;
        }

        .dynamics-cell.active {
            background: rgba(102, 126, 234, 0.2);
            border: 2px solid #667eea;
        }

        .dynamics-cell.tension {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
        }

        .dynamics-cell.synergy {
            background: rgba(26, 188, 156, 0.2);
            border: 2px solid #1abc9c;
        }

        /* BIFURCATION ANALYSIS */
        .bifurcation-container {
            background: #1a1f3a;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            position: relative;
        }

        .bifurcation-title {
            font-size: 18px;
            font-weight: 700;
            color: #e0e0e0;
            margin-bottom: 20px;
        }

        .pathway {
            background: #0a0e27;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border-left: 4px solid #667eea;
        }

        .pathway-name {
            font-size: 15px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }

        .pathway-probability {
            font-size: 12px;
            color: #888;
            margin-bottom: 12px;
        }

        .pathway-description {
            font-size: 13px;
            color: #b0b0b0;
            line-height: 1.6;
        }

        /* RRI FIELD VISUALIZATION */
        .rri-field {
            background: #1a1f3a;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 30px;
            position: relative;
        }

        .rri-title {
            font-size: 18px;
            font-weight: 700;
            color: #e0e0e0;
            margin-bottom: 20px;
        }

        .rri-current {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .rri-dimension {
            background: #0a0e27;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .rri-dimension-name {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .rri-dimension-value {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .rri-transformation {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            padding: 16px;
        }

        .rri-transformation-text {
            font-size: 13px;
            color: #b0b0b0;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚ö° Adaptive Capital Analyzer</h1>
        <p>Relational assessment across nested system scales</p>
    </div>

    <div class="main-container">
        <!-- INPUT PANEL -->
        <div class="input-panel">
            <div class="context-box">
                <h3>üéØ Purpose</h3>
                <p>This tool maps investment opportunities across three nested panarchy cycles to understand phase relationships, cross-scale dynamics, and appropriate adaptive capital behavior.</p>
            </div>

            <!-- BASIC INFO -->
            <div class="section">
                <div class="section-header">
                    <span class="section-icon">üìã</span>
                    <div>
                        <div class="section-title">Investment Context</div>
                        <div class="section-subtitle">Basic identifying information</div>
                    </div>
                </div>
                <div class="input-group">
                    <label class="input-label">Organization Name</label>
                    <input type="text" id="orgName" placeholder="e.g., Persephone Brewing Company">
                </div>
                <div class="input-group">
                    <label class="input-label">Sector/Domain</label>
                    <input type="text" id="sector" placeholder="e.g., Sustainable Food Systems">
                </div>
                <div class="input-group">
                    <label class="input-label">Investment Amount Sought ($)</label>
                    <input type="number" id="amount" placeholder="e.g., 500000">
                </div>
            </div>

            <!-- LEVEL 1: ENTERPRISE CYCLE -->
            <div class="section enterprise-section" style="background: linear-gradient(135deg, rgba(26, 188, 156, 0.05) 0%, rgba(26, 188, 156, 0.02) 100%); padding: 20px; border-radius: 12px; border: 1px solid rgba(26, 188, 156, 0.2);">
                <div class="section-header">
                    <span class="section-icon">üè¢</span>
                    <div>
                        <div class="section-title" style="color: #1abc9c;">Level 1: SFI Product Cycle Position</div>
                        <div class="section-subtitle">Where is this organization in its adaptive cycle?</div>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">Current Phase (best guess)</label>
                    <div class="phase-indicator-grid">
                        <div class="phase-option" data-phase="r" onclick="selectPhase('enterprise', 'r')">
                            <div class="phase-option-label">r - Growth</div>
                            <div class="phase-option-desc">Exploring, adapting</div>
                        </div>
                        <div class="phase-option" data-phase="K" onclick="selectPhase('enterprise', 'K')">
                            <div class="phase-option-label">K - Conservation</div>
                            <div class="phase-option-desc">Optimizing, scaling</div>
                        </div>
                        <div class="phase-option" data-phase="omega" onclick="selectPhase('enterprise', 'omega')">
                            <div class="phase-option-label">Œ© - Release</div>
                            <div class="phase-option-desc">Disruption, crisis</div>
                        </div>
                        <div class="phase-option" data-phase="alpha" onclick="selectPhase('enterprise', 'alpha')">
                            <div class="phase-option-label">Œ± - Reorganization</div>
                            <div class="phase-option-desc">Innovating, recombining</div>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">Innovation Rate (experimentation vs. optimization)</label>
                    <input type="range" min="0" max="100" value="50" class="slider" id="innovationRate">
                    <div class="slider-labels">
                        <span>Optimizing existing</span>
                        <span>Rapid experimentation</span>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">Connectedness (how tightly coupled are operations?)</label>
                    <input type="range" min="0" max="100" value="50" class="slider" id="connectedness">
                    <div class="slider-labels">
                        <span>Loosely coupled</span>
                        <span>Highly integrated</span>
                    </div>
                    <div class="input-hint">High connectedness in K-phase = potential brittleness</div>
                </div>

                <div class="input-group">
                    <label class="input-label">Resilience Signals (diversity of revenue, slack resources, adaptive capacity)</label>
                    <input type="range" min="0" max="100" value="50" class="slider" id="resilience">
                    <div class="slider-labels">
                        <span>Fragile/brittle</span>
                        <span>Highly resilient</span>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">Precise Position in Cycle (0-360¬∞)</label>
                    <input type="range" min="0" max="360" value="45" class="slider" id="cyclePosition" oninput="updateCyclePositionDisplay()">
                    <div class="slider-labels">
                        <span>r start (0¬∞)</span>
                        <span id="cyclePositionValue">45¬∞</span>
                        <span>back to r (360¬∞)</span>
                    </div>
                    <div class="input-hint">
                        r: 0-90¬∞ | K: 90-180¬∞ | Œ©: 180-270¬∞ | Œ±: 270-360¬∞
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">Time in Current Phase (months)</label>
                    <input type="number" id="timeInPhase" placeholder="e.g., 18" min="0">
                    <div class="input-hint">Longer time = higher transition probability</div>
                </div>

                <div class="input-group">
                    <label class="input-label">Transition Signals (signs of approaching phase shift)</label>
                    <select id="transitionSignals" multiple size="4" style="width: 100%; padding: 8px; background: #0a0e27; border: 1px solid #2a3555; border-radius: 6px; color: #e0e0e0; font-size: 13px;">
                        <option value="revenue_plateauing">Revenue growth plateauing</option>
                        <option value="team_turnover">Increased team turnover</option>
                        <option value="innovation_slowing">Innovation rate slowing</option>
                        <option value="market_pressure">External market pressures mounting</option>
                        <option value="efficiency_gains">Diminishing efficiency gains</option>
                        <option value="customer_churn">Rising customer churn</option>
                        <option value="competitive_threats">New competitive threats emerging</option>
                        <option value="technology_shifts">Technology disruption visible</option>
                        <option value="regulatory_changes">Regulatory environment shifting</option>
                        <option value="capital_constraints">Capital becoming constrained</option>
                    </select>
                    <div class="input-hint">Hold Ctrl/Cmd to select multiple signals</div>
                </div>
            </div>

            <!-- LEVEL 2: PORTFOLIO CYCLE -->
            <div class="section portfolio-section" style="background: linear-gradient(135deg, rgba(52, 152, 219, 0.05) 0%, rgba(52, 152, 219, 0.02) 100%); padding: 20px; border-radius: 12px; border: 1px solid rgba(52, 152, 219, 0.2);">
                <div class="section-header">
                    <span class="section-icon">üìÅ</span>
                    <div>
                        <div class="section-title" style="color: #3498db;">Level 2: Boann Portfolio Cycle Position</div>
                        <div class="section-subtitle">Where is Boann's portfolio in its cycle?</div>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">Portfolio Phase</label>
                    <div class="phase-indicator-grid">
                        <div class="phase-option" data-phase="r" onclick="selectPhase('portfolio', 'r')">
                            <div class="phase-option-label">r - Growth</div>
                            <div class="phase-option-desc">Building positions</div>
                        </div>
                        <div class="phase-option" data-phase="K" onclick="selectPhase('portfolio', 'K')">
                            <div class="phase-option-label">K - Conservation</div>
                            <div class="phase-option-desc">Mature, optimized</div>
                        </div>
                        <div class="phase-option" data-phase="omega" onclick="selectPhase('portfolio', 'omega')">
                            <div class="phase-option-label">Œ© - Release</div>
                            <div class="phase-option-desc">Restructuring</div>
                        </div>
                        <div class="phase-option" data-phase="alpha" onclick="selectPhase('portfolio', 'alpha')">
                            <div class="phase-option-label">Œ± - Reorganization</div>
                            <div class="phase-option-desc">New strategy emerging</div>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">Portfolio Cycle Position (0-360¬∞)</label>
                    <input type="range" min="0" max="360" value="120" class="slider" id="portfolioCyclePosition" oninput="updatePortfolioCyclePositionDisplay()">
                    <div class="slider-labels">
                        <span>r start (0¬∞)</span>
                        <span id="portfolioCyclePositionValue">120¬∞</span>
                        <span>back to r (360¬∞)</span>
                    </div>
                    <div class="input-hint">
                        r: 0-90¬∞ | K: 90-180¬∞ | Œ©: 180-270¬∞ | Œ±: 270-360¬∞
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">Similar Investments in Portfolio</label>
                    <input type="number" id="similarInvestments" placeholder="e.g., 2" min="0">
                    <div class="input-hint">Creates connectedness - could amplify or dampen enterprise dynamics</div>
                </div>

                <div class="input-group">
                    <label class="input-label">Portfolio Concentration Risk</label>
                    <input type="range" min="0" max="100" value="50" class="slider" id="concentration">
                    <div class="slider-labels">
                        <span>Highly diversified</span>
                        <span>Concentrated</span>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">How would this deal shift portfolio dynamics?</label>
                    <select id="portfolioShift" multiple size="4" style="width: 100%; padding: 8px; background: #0a0e27; border: 1px solid #2a3555; border-radius: 6px; color: #e0e0e0; font-size: 13px;">
                        <option value="sector_concentration">Increases sector concentration</option>
                        <option value="sector_diversification">Adds new sector diversification</option>
                        <option value="geography_expansion">Expands geographic footprint</option>
                        <option value="stage_balance">Balances portfolio stage mix</option>
                        <option value="risk_profile">Shifts overall risk profile</option>
                        <option value="impact_thesis">Strengthens impact thesis alignment</option>
                        <option value="financial_returns">Improves expected financial returns</option>
                        <option value="integration_model">Introduces new integration model</option>
                        <option value="ticket_size">Changes average ticket size</option>
                        <option value="liquidity_timeline">Affects portfolio liquidity timeline</option>
                    </select>
                    <div class="input-hint">Hold Ctrl/Cmd to select multiple dynamics</div>
                </div>
            </div>

            <!-- LEVEL 3: MARKET CYCLE -->
            <div class="section market-section" style="background: linear-gradient(135deg, rgba(231, 76, 60, 0.05) 0%, rgba(231, 76, 60, 0.02) 100%); padding: 20px; border-radius: 12px; border: 1px solid rgba(231, 76, 60, 0.2);">
                <div class="section-header">
                    <span class="section-icon">üåç</span>
                    <div>
                        <div class="section-title" style="color: #e74c3c;">Level 3: CDN Impact-Finance Market Cycle Position</div>
                        <div class="section-subtitle">Where is the sector/market in its cycle?</div>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">Market Phase</label>
                    <div class="phase-indicator-grid">
                        <div class="phase-option" data-phase="r" onclick="selectPhase('market', 'r')">
                            <div class="phase-option-label">r - Growth</div>
                            <div class="phase-option-desc">Expanding rapidly</div>
                        </div>
                        <div class="phase-option" data-phase="K" onclick="selectPhase('market', 'K')">
                            <div class="phase-option-label">K - Conservation</div>
                            <div class="phase-option-desc">Mature, stable</div>
                        </div>
                        <div class="phase-option" data-phase="omega" onclick="selectPhase('market', 'omega')">
                            <div class="phase-option-label">Œ© - Release</div>
                            <div class="phase-option-desc">Disruption active</div>
                        </div>
                        <div class="phase-option" data-phase="alpha" onclick="selectPhase('market', 'alpha')">
                            <div class="phase-option-label">Œ± - Reorganization</div>
                            <div class="phase-option-desc">New models emerging</div>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">Market Cycle Position (0-360¬∞)</label>
                    <input type="range" min="0" max="360" value="200" class="slider" id="marketCyclePosition" oninput="updateMarketCyclePositionDisplay()">
                    <div class="slider-labels">
                        <span>r start (0¬∞)</span>
                        <span id="marketCyclePositionValue">200¬∞</span>
                        <span>back to r (360¬∞)</span>
                    </div>
                    <div class="input-hint">
                        r: 0-90¬∞ | K: 90-180¬∞ | Œ©: 180-270¬∞ | Œ±: 270-360¬∞
                    </div>
                </div>

                <div class="input-group">
                    <label class="input-label">Policy Cycle Phase</label>
                    <select id="policyPhase">
                        <option value="r">New programs launching (r)</option>
                        <option value="K">Established support (K)</option>
                        <option value="omega">Funding cuts/restructuring (Œ©)</option>
                        <option value="alpha">Policy innovation emerging (Œ±)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label class="input-label">Bifurcation Indicators (multiple possible futures emerging?)</label>
                    <select id="bifurcation" multiple size="4" style="width: 100%; padding: 8px; background: #0a0e27; border: 1px solid #2a3555; border-radius: 6px; color: #e0e0e0; font-size: 13px;">
                        <option value="consolidation_fragmentation">Consolidation vs. Fragmentation pathways visible</option>
                        <option value="centralized_distributed">Centralized vs. Distributed models emerging</option>
                        <option value="technology_incumbent">Technology disruption vs. Incumbent adaptation</option>
                        <option value="scale_local">Scale efficiency vs. Local resilience</option>
                        <option value="growth_sustainability">Growth maximization vs. Sustainability focus</option>
                        <option value="platform_vertical">Platform model vs. Vertical integration</option>
                        <option value="partnerships_acquisition">Partnership vs. Acquisition strategies</option>
                        <option value="regulatory_paths">Multiple regulatory pathways emerging</option>
                        <option value="customer_segments">Diverging customer segment needs</option>
                        <option value="business_models">Competing business model viability</option>
                    </select>
                    <div class="input-hint">Hold Ctrl/Cmd to select multiple pathways</div>
                </div>
            </div>

            <button class="analyze-btn" onclick="analyzeInvestment()">
                üîç Analyze Relational Dynamics
            </button>
        </div>

        <!-- ANALYSIS PANEL -->
        <div class="analysis-panel" id="analysisPanel">
            <div class="analysis-empty">
                <div class="analysis-empty-icon">üåÄ</div>
                <h3>Ready for Relational Analysis</h3>
                <p style="margin-top: 12px; color: #888;">Enter system positions across all three scales to map phase relationships and adaptive capital behavior</p>
            </div>
        </div>
    </div>

    <script>
        // State management
        let analysisState = {
            enterprise: { phase: null, cyclePosition: 45, innovation: 50, connectedness: 50, resilience: 50, timeInPhase: null },
            portfolio: { phase: null, cyclePosition: 120, similar: 0, concentration: 50 },
            market: { phase: null, cyclePosition: 200, velocity: 50, policy: null }
        };

        // Animation state
        let animationState = {
            isAnimating: false,
            animationFrame: null,
            timeElapsed: 0,
            velocities: {
                enterprise: 48,  // months per full cycle
                portfolio: 84,
                market: 60
            },
            speed: 1.0  // Animation speed multiplier (0.05x to 2.0x)
        };

        // Update animation speed
        function updateAnimationSpeed() {
            const speedInput = document.getElementById('animationSpeed').value;
            // Convert range 1-20 to speed multiplier 0.05x - 2.0x
            // 1 = 0.05x (very slow), 10 = 1.0x (normal), 20 = 2.0x (fast)
            if (speedInput <= 10) {
                animationState.speed = 0.05 + (speedInput - 1) * 0.105; // 0.05 to 1.0
            } else {
                animationState.speed = 1.0 + (speedInput - 10) * 0.1; // 1.0 to 2.0
            }
            document.getElementById('speedDisplay').textContent = animationState.speed.toFixed(2) + 'x';
        }

        // Toggle animation
        function toggleAnimation() {
            const checkbox = document.getElementById('animationToggle');
            animationState.isAnimating = checkbox.checked;
            
            if (animationState.isAnimating) {
                startAnimation();
            } else {
                stopAnimation();
            }
        }

        // Toggle pause (separate from stopping animation entirely)
        function togglePause() {
            animationState.isAnimating = !animationState.isAnimating;
            
            // Update all pause buttons
            const pauseBtns = ['pauseBtn', 'pauseBtn2', 'pauseBtn3', 'pauseBtn4'];
            pauseBtns.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    if (animationState.isAnimating) {
                        btn.textContent = '‚è∏ Pause';
                        btn.classList.remove('paused');
                    } else {
                        btn.textContent = '‚ñ∂ Resume';
                        btn.classList.add('paused');
                    }
                }
            });
            
            if (animationState.isAnimating) {
                startAnimation();
            } else {
                stopAnimation();
            }
        }

        function startAnimation() {
            if (!animationState.animationFrame) {
                animate();
            }
        }

        function stopAnimation() {
            if (animationState.animationFrame) {
                cancelAnimationFrame(animationState.animationFrame);
                animationState.animationFrame = null;
            }
        }

        function animate() {
            if (!animationState.isAnimating) return;
            
            // Increment time with speed multiplier
            // Base increment of 0.1 months per frame, adjusted by speed
            const timeIncrement = 0.1 * animationState.speed;
            animationState.timeElapsed += timeIncrement;
            
            // Update positions based on velocities and speed
            const { enterprise, portfolio, market } = animationState.velocities;
            
            analysisState.enterprise.cyclePosition = (analysisState.enterprise.cyclePosition + (360 / enterprise * timeIncrement)) % 360;
            analysisState.portfolio.cyclePosition = (analysisState.portfolio.cyclePosition + (360 / portfolio * timeIncrement)) % 360;
            analysisState.market.cyclePosition = (analysisState.market.cyclePosition + (360 / market * timeIncrement)) % 360;
            
            // Update phases based on positions
            updatePhaseFromPosition('enterprise', analysisState.enterprise.cyclePosition);
            updatePhaseFromPosition('portfolio', analysisState.portfolio.cyclePosition);
            updatePhaseFromPosition('market', analysisState.market.cyclePosition);
            
            // Update UI
            document.getElementById('cyclePosition').value = Math.round(analysisState.enterprise.cyclePosition);
            document.getElementById('cyclePositionValue').textContent = Math.round(analysisState.enterprise.cyclePosition) + '¬∞';
            
            document.getElementById('portfolioCyclePosition').value = Math.round(analysisState.portfolio.cyclePosition);
            document.getElementById('portfolioCyclePositionValue').textContent = Math.round(analysisState.portfolio.cyclePosition) + '¬∞';
            
            document.getElementById('marketCyclePosition').value = Math.round(analysisState.market.cyclePosition);
            document.getElementById('marketCyclePositionValue').textContent = Math.round(analysisState.market.cyclePosition) + '¬∞';
            
            document.getElementById('timeElapsed').textContent = Math.round(animationState.timeElapsed);
            
            // Redraw visualization
            if (document.getElementById('phaseCanvas')) {
                drawPhaseRelationships();
                updateDynamicInsights();
                updateCrossScaleAnalysis();
                updateCapitalBehavior();
                updateBifurcationAnalysis();
                updateRRIField();
                updateDynamicsMatrix();
            }
            
            animationState.animationFrame = requestAnimationFrame(animate);
        }

        function updatePhaseFromPosition(level, position) {
            if (position < 90) {
                analysisState[level].phase = 'r';
            } else if (position < 180) {
                analysisState[level].phase = 'K';
            } else if (position < 270) {
                analysisState[level].phase = 'omega';
            } else {
                analysisState[level].phase = 'alpha';
            }
        }

        function updateVelocities() {
            animationState.velocities.enterprise = parseInt(document.getElementById('enterpriseVelocity').value) || 48;
            animationState.velocities.portfolio = parseInt(document.getElementById('portfolioVelocity').value) || 84;
            animationState.velocities.market = parseInt(document.getElementById('marketVelocity').value) || 60;
        }

        // Update cycle position display for enterprise
        function updateCyclePositionDisplay() {
            const position = document.getElementById('cyclePosition').value;
            document.getElementById('cyclePositionValue').textContent = position + '¬∞';
            analysisState.enterprise.cyclePosition = parseInt(position);
            
            // Update the phase based on position
            if (position < 90) {
                analysisState.enterprise.phase = 'r';
            } else if (position < 180) {
                analysisState.enterprise.phase = 'K';
            } else if (position < 270) {
                analysisState.enterprise.phase = 'omega';
            } else {
                analysisState.enterprise.phase = 'alpha';
            }
            
            // If analysis is already displayed, update it in real-time
            if (document.getElementById('phaseCanvas')) {
                drawPhaseRelationships();
                updateDynamicInsights();
            }
        }

        // Update cycle position display for portfolio
        function updatePortfolioCyclePositionDisplay() {
            const position = document.getElementById('portfolioCyclePosition').value;
            document.getElementById('portfolioCyclePositionValue').textContent = position + '¬∞';
            analysisState.portfolio.cyclePosition = parseInt(position);
            
            // Update the phase based on position
            if (position < 90) {
                analysisState.portfolio.phase = 'r';
            } else if (position < 180) {
                analysisState.portfolio.phase = 'K';
            } else if (position < 270) {
                analysisState.portfolio.phase = 'omega';
            } else {
                analysisState.portfolio.phase = 'alpha';
            }
            
            // If analysis is already displayed, update it in real-time
            if (document.getElementById('phaseCanvas')) {
                drawPhaseRelationships();
                updateCrossScaleAnalysis();
            }
        }

        // Update cycle position display for market
        function updateMarketCyclePositionDisplay() {
            const position = document.getElementById('marketCyclePosition').value;
            document.getElementById('marketCyclePositionValue').textContent = position + '¬∞';
            analysisState.market.cyclePosition = parseInt(position);
            
            // Update the phase based on position
            if (position < 90) {
                analysisState.market.phase = 'r';
            } else if (position < 180) {
                analysisState.market.phase = 'K';
            } else if (position < 270) {
                analysisState.market.phase = 'omega';
            } else {
                analysisState.market.phase = 'alpha';
            }
            
            // If analysis is already displayed, update it in real-time
            if (document.getElementById('phaseCanvas')) {
                drawPhaseRelationships();
                updateCrossScaleAnalysis();
            }
        }

        // Phase selection
        function selectPhase(level, phase) {
            // Map level names to what's in the section titles
            const levelMapping = {
                'enterprise': 'SFI',
                'portfolio': 'Boann Portfolio',
                'market': 'CDN Impact-Finance Market'
            };
            
            const searchTerm = levelMapping[level] || level;
            
            // Find the section containing this level's phase options
            const sections = document.querySelectorAll('.section');
            let targetSection = null;
            
            sections.forEach(section => {
                const titleText = section.querySelector('.section-title')?.textContent || '';
                if (titleText.includes(searchTerm)) {
                    targetSection = section;
                }
            });
            
            if (targetSection) {
                // Clear previous selections in this section
                targetSection.querySelectorAll('.phase-option').forEach(el => {
                    el.classList.remove('selected');
                });
                
                // Select new phase
                const clickedOption = targetSection.querySelector(`.phase-option[data-phase="${phase}"]`);
                if (clickedOption) {
                    clickedOption.classList.add('selected');
                }
            }
            
            // Update state (keep using original variable names)
            analysisState[level].phase = phase;
        }

        // Main analysis function
        function analyzeInvestment() {
            // Gather all inputs
            const orgName = document.getElementById('orgName').value || 'Investment Opportunity';
            const sector = document.getElementById('sector').value || 'Sector';
            const amount = document.getElementById('amount').value || '0';
            
            analysisState.enterprise.cyclePosition = parseInt(document.getElementById('cyclePosition').value);
            analysisState.enterprise.innovation = document.getElementById('innovationRate').value;
            analysisState.enterprise.connectedness = document.getElementById('connectedness').value;
            analysisState.enterprise.resilience = document.getElementById('resilience').value;
            analysisState.enterprise.timeInPhase = document.getElementById('timeInPhase').value;
            
            analysisState.portfolio.cyclePosition = parseInt(document.getElementById('portfolioCyclePosition').value);
            analysisState.portfolio.similar = document.getElementById('similarInvestments').value || 0;
            analysisState.portfolio.concentration = document.getElementById('concentration').value;
            
            analysisState.market.cyclePosition = parseInt(document.getElementById('marketCyclePosition').value);
            analysisState.market.policy = document.getElementById('policyPhase').value;

            // Auto-set phases based on cycle positions
            const ePos = analysisState.enterprise.cyclePosition;
            if (ePos < 90) {
                analysisState.enterprise.phase = 'r';
            } else if (ePos < 180) {
                analysisState.enterprise.phase = 'K';
            } else if (ePos < 270) {
                analysisState.enterprise.phase = 'omega';
            } else {
                analysisState.enterprise.phase = 'alpha';
            }

            const pPos = analysisState.portfolio.cyclePosition;
            if (pPos < 90) {
                analysisState.portfolio.phase = 'r';
            } else if (pPos < 180) {
                analysisState.portfolio.phase = 'K';
            } else if (pPos < 270) {
                analysisState.portfolio.phase = 'omega';
            } else {
                analysisState.portfolio.phase = 'alpha';
            }

            const mPos = analysisState.market.cyclePosition;
            if (mPos < 90) {
                analysisState.market.phase = 'r';
            } else if (mPos < 180) {
                analysisState.market.phase = 'K';
            } else if (mPos < 270) {
                analysisState.market.phase = 'omega';
            } else {
                analysisState.market.phase = 'alpha';
            }

            // Generate analysis
            const analysis = generateAnalysis(orgName, sector, amount);
            
            // Render results
            document.getElementById('analysisPanel').innerHTML = analysis;
            
            // Draw visualization
            setTimeout(() => drawPhaseRelationships(), 100);
        }

        function generateAnalysis(orgName, sector, amount) {
            const { enterprise, portfolio, market } = analysisState;
            
            // Calculate cross-scale dynamics
            const dynamics = assessCrossScaleDynamics();
            const rriField = calculateRRIField();
            const bifurcations = identifyBifurcations();
            const capitalBehavior = determineCapitalBehavior();

            return `
                <!-- PHASE RELATIONSHIP MAP -->
                <div class="phase-map-container">
                    <div class="phase-map-title">üåÄ Nested Panarchy Cycles - Live Relational Dynamics</div>
                    
                    <!-- Animation Controls -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; gap: 20px;">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="animationToggle" onchange="toggleAnimation()" style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-weight: 600; font-size: 14px; color: #e0e0e0;">Animate Cycles</span>
                            </label>
                            <div style="border-left: 2px solid #2a3555; padding-left: 20px; display: flex; align-items: center; gap: 12px;">
                                <label style="font-size: 13px; color: #b0b0b0;">Animation Speed:</label>
                                <input type="range" min="1" max="20" value="10" id="animationSpeed" 
                                       oninput="updateAnimationSpeed()" 
                                       style="width: 150px; height: 6px; background: #2a3555; border-radius: 3px; outline: none; -webkit-appearance: none;">
                                <span id="speedDisplay" style="font-size: 12px; color: #667eea; font-weight: 600; min-width: 60px;">1.0x</span>
                            </div>
                            <span style="font-size: 11px; color: #666; font-style: italic;">‚Üê Slower | Faster ‚Üí</span>
                        </div>
                        <div style="font-size: 12px; color: #888;">
                            <span id="timeElapsed">0</span> months elapsed
                        </div>
                    </div>

                    <!-- Main visualization area with controls on right -->
                    <div style="display: grid; grid-template-columns: 1fr 300px; gap: 20px;">
                        <!-- Canvas on left -->
                        <div>
                            <canvas id="phaseCanvas" style="width: 100%; height: 600px;"></canvas>
                        </div>
                        
                        <!-- Cycle controls stacked vertically on right -->
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            <!-- CDN Impact-Finance Market Controls (top) -->
                            <div style="background: rgba(231, 76, 60, 0.1); border: 1px solid rgba(231, 76, 60, 0.3); border-radius: 8px; padding: 16px;">
                                <div style="font-size: 13px; font-weight: 700; color: #e74c3c; margin-bottom: 16px; text-align: center;">
                                    üåç CDN IMPACT-FINANCE MARKET
                                </div>
                                <div>
                                    <label style="font-size: 11px; color: #888; display: block; margin-bottom: 6px;">Velocity (months/full cycle)</label>
                                    <input type="number" id="marketVelocity" value="60" min="12" max="240" 
                                           style="width: 100%; padding: 6px; background: #0a0e27; border: 1px solid #2a3555; border-radius: 4px; color: #e0e0e0; font-size: 12px;"
                                           oninput="updateVelocities()">
                                    <div style="font-size: 9px; color: #e74c3c; margin-top: 4px; line-height: 1.3;">
                                        üí° Suggested: 48-96 months<br>
                                        <span style="color: #666;">Can be volatile or stable</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Boann Portfolio Controls (middle) -->
                            <div style="background: rgba(52, 152, 219, 0.1); border: 1px solid rgba(52, 152, 219, 0.3); border-radius: 8px; padding: 16px;">
                                <div style="font-size: 13px; font-weight: 700; color: #3498db; margin-bottom: 16px; text-align: center;">
                                    üìÅ BOANN PORTFOLIO
                                </div>
                                <div>
                                    <label style="font-size: 11px; color: #888; display: block; margin-bottom: 6px;">Velocity (months/full cycle)</label>
                                    <input type="number" id="portfolioVelocity" value="84" min="12" max="240" 
                                           style="width: 100%; padding: 6px; background: #0a0e27; border: 1px solid #2a3555; border-radius: 4px; color: #e0e0e0; font-size: 12px;"
                                           oninput="updateVelocities()">
                                    <div style="font-size: 9px; color: #3498db; margin-top: 4px; line-height: 1.3;">
                                        üí° Suggested: 72-120 months<br>
                                        <span style="color: #666;">Institutional timeframes</span>
                                    </div>
                                </div>
                            </div>

                            <!-- SFI Controls (bottom) -->
                            <div style="background: rgba(26, 188, 156, 0.1); border: 1px solid rgba(26, 188, 156, 0.3); border-radius: 8px; padding: 16px;">
                                <div style="font-size: 13px; font-weight: 700; color: #1abc9c; margin-bottom: 16px; text-align: center;">
                                    üè¢ SFI
                                </div>
                                <div>
                                    <label style="font-size: 11px; color: #888; display: block; margin-bottom: 6px;">Velocity (months/full cycle)</label>
                                    <input type="number" id="enterpriseVelocity" value="48" min="12" max="240" 
                                           style="width: 100%; padding: 6px; background: #0a0e27; border: 1px solid #2a3555; border-radius: 4px; color: #e0e0e0; font-size: 12px;"
                                           oninput="updateVelocities()">
                                    <div style="font-size: 9px; color: #1abc9c; margin-top: 4px; line-height: 1.3;">
                                        üí° Suggested: 36-60 months<br>
                                        <span style="color: #666;">SFIs adapt quickly</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KEY INSIGHTS -->
                <div class="insights-container">
                    <div class="insight-card">
                        <div class="insight-header">
                            <div class="insight-icon">üìç</div>
                            <div class="insight-title">Precise Cycle Position</div>
                        </div>
                        <div class="insight-content" id="subPhaseGuidance">
                            ${generateSubPhaseGuidance()}
                        </div>
                    </div>

                    <div class="insight-card">
                        <div class="insight-header">
                            <div class="insight-icon">üéØ</div>
                            <div class="insight-title">Phase Alignment</div>
                        </div>
                        <div class="insight-content">
                            ${generateAlignmentInsight()}
                        </div>
                    </div>

                    <div class="insight-card">
                        <div class="insight-header">
                            <div class="insight-icon">‚ö°</div>
                            <div class="insight-title">Cross-Scale Forces</div>
                        </div>
                        <div class="insight-content">
                            ${generateCrossScaleInsight()}
                        </div>
                    </div>

                    <div class="insight-card">
                        <div class="insight-header">
                            <div class="insight-icon">üîÑ</div>
                            <div class="insight-title">Transition Probability</div>
                        </div>
                        <div class="insight-content">
                            ${generateTransitionInsight()}
                        </div>
                    </div>
                </div>

                <!-- RRI FIELD -->
                <div class="rri-field">
                    <button class="pause-btn" onclick="togglePause()" id="pauseBtn">‚è∏ Pause</button>
                    <div class="rri-title">Risk-Return-Impact Entanglement</div>
                    <div class="rri-current">
                        <div class="rri-dimension">
                            <div class="rri-dimension-name">Risk</div>
                            <div class="rri-dimension-value">${rriField.risk}</div>
                        </div>
                        <div class="rri-dimension">
                            <div class="rri-dimension-name">Return</div>
                            <div class="rri-dimension-value">${rriField.return}</div>
                        </div>
                        <div class="rri-dimension">
                            <div class="rri-dimension-name">Impact</div>
                            <div class="rri-dimension-value">${rriField.impact}</div>
                        </div>
                    </div>
                    <div class="rri-transformation">
                        <div class="rri-transformation-text">${rriField.transformation}</div>
                    </div>
                </div>

                <!-- CAPITAL BEHAVIOR RECOMMENDATIONS -->
                <div class="capital-behavior">
                    <button class="pause-btn" onclick="togglePause()" id="pauseBtn2">‚è∏ Pause</button>
                    <div class="capital-behavior-title">üí∞ Adaptive Capital Behavior Recommendations</div>
                    <div class="behavior-timeline">
                        ${capitalBehavior}
                    </div>
                </div>

                <!-- CROSS-SCALE DYNAMICS MATRIX -->
                <div class="dynamics-matrix">
                    <button class="pause-btn" onclick="togglePause()" id="pauseBtn3">‚è∏ Pause</button>
                    <div class="dynamics-title">Cross-Scale Dynamics Matrix</div>
                    <div class="dynamics-grid">
                        ${generateDynamicsMatrix()}
                    </div>
                </div>

                <!-- BIFURCATION ANALYSIS -->
                <div class="bifurcation-container">
                    <button class="pause-btn" onclick="togglePause()" id="pauseBtn4">‚è∏ Pause</button>
                    <div class="bifurcation-title">üîÄ Bifurcation Pathways</div>
                    ${bifurcations}
                </div>
            `;
        }

        function generateAlignmentInsight() {
            const { enterprise, portfolio, market } = analysisState;
            
            if (enterprise.phase === portfolio.phase && portfolio.phase === market.phase) {
                return `<strong>High Resonance:</strong> All three scales are in ${getPhaseFullName(enterprise.phase)} phase. This creates powerful amplification‚Äîboth opportunities and risks are magnified. Capital should lean into phase-appropriate behavior with confidence.`;
            }
            
            if (enterprise.phase === 'r' && market.phase === 'omega') {
                return `<strong>Bifurcation Window:</strong> Enterprise in growth while market disrupts‚Äîthis is a transformation opportunity. The enterprise's adaptability positions it to thrive in market reorganization. Capital should be catalytic and patient.`;
            }
            
            if (enterprise.phase === 'K' && market.phase === 'omega') {
                return `<strong>High Tension:</strong> Enterprise optimizing while market disrupts‚Äîsignificant mismatch. Enterprise may lack flexibility to navigate market transition. Capital needs to create adaptive capacity or risk catastrophic failure.`;
            }
            
            return `<strong>Mixed Dynamics:</strong> Phases differ across scales, creating complex cross-scale interactions. Capital behavior must be nuanced, responding to multiple simultaneous phase requirements.`;
        }

        function generateSubPhaseGuidance() {
            const position = analysisState.enterprise.cyclePosition;
            
            let subPhase = '';
            let capitalGuidance = '';
            
            if (position >= 0 && position < 90) {
                const progress = position / 90;
                if (progress < 0.33) {
                    subPhase = 'Early r-phase: Maximum exploration';
                    capitalGuidance = 'Encourage wide experimentation, multiple bets, high variance. Avoid forcing convergence.';
                } else if (progress < 0.66) {
                    subPhase = 'Mid r-phase: Learning acceleration';
                    capitalGuidance = 'Support rapid learning cycles, adaptive pivots. Begin identifying patterns in successes.';
                } else {
                    subPhase = 'Late r-phase: Emerging structures';
                    capitalGuidance = 'Prepare for K transition. Start building optimization capabilities while maintaining flexibility.';
                }
            } else if (position >= 90 && position < 180) {
                const progress = (position - 90) / 90;
                if (progress < 0.33) {
                    subPhase = 'Early K-phase: Efficiency building';
                    capitalGuidance = 'Invest in optimization, scale proven models. Returns should stabilize and increase.';
                } else if (progress < 0.66) {
                    subPhase = 'Mid K-phase: Peak optimization';
                    capitalGuidance = 'Maximum efficiency, stable returns. But monitor brittleness‚Äîhigh connectedness = fragility.';
                } else {
                    subPhase = 'Late K-phase: Brittleness warning';
                    capitalGuidance = 'CRITICAL: System may be over-optimized. Build liquidity buffers, prepare for disruption. Brittleness is HIGH.';
                }
            } else if (position >= 180 && position < 270) {
                const progress = (position - 180) / 90;
                if (progress < 0.33) {
                    subPhase = 'Early Œ©-phase: Disruption onset';
                    capitalGuidance = 'Shift to pure patience. Suspend optimization demands. Protect core capabilities. Bifurcation approaching.';
                } else if (progress < 0.66) {
                    subPhase = 'Mid Œ©-phase: Bifurcation point';
                    capitalGuidance = 'BIFURCATION ACTIVE: Multiple futures visible. Capital must choose: support transformation or manage decline.';
                } else {
                    subPhase = 'Late Œ©-phase: Release completing';
                    capitalGuidance = 'Prepare for Œ± emergence. If transforming: position for catalytic participation. If declining: orderly exit.';
                }
            } else {
                const progress = (position - 270) / 90;
                if (progress < 0.33) {
                    subPhase = 'Early Œ±-phase: Reorganization begins';
                    capitalGuidance = 'Enable recombination, novel partnerships, structural innovation. Small capital = large leverage.';
                } else if (progress < 0.66) {
                    subPhase = 'Mid Œ±-phase: New structures forming';
                    capitalGuidance = 'Co-evolve terms with emerging structures. Support experimentation but with more direction than r-phase.';
                } else {
                    subPhase = 'Late Œ±-phase: Stabilization approaching';
                    capitalGuidance = 'New model crystallizing. Prepare for r-phase transition. Begin scaling what works.';
                }
            }
            
            return `
                <div style="margin-bottom: 12px;">
                    <strong style="color: #667eea;">${subPhase}</strong><br>
                    <span style="font-size: 12px; color: #888;">Position: ${position}¬∞ in cycle</span>
                </div>
                <div style="font-size: 13px; color: #b0b0b0; line-height: 1.6;">
                    ${capitalGuidance}
                </div>
            `;
        }

        function generateCrossScaleInsight() {
            const similar = parseInt(analysisState.portfolio.similar) || 0;
            const concentration = parseInt(analysisState.portfolio.concentration);
            
            // Get selected portfolio shifts
            const portfolioShiftSelect = document.getElementById('portfolioShift');
            const selectedShifts = portfolioShiftSelect ? Array.from(portfolioShiftSelect.selectedOptions).map(opt => opt.text) : [];
            
            if (similar > 3 && concentration > 70) {
                let shiftNote = '';
                if (selectedShifts.length > 0) {
                    shiftNote = ` This deal would: ${selectedShifts.join('; ')}.`;
                }
                return `<strong>‚ö†Ô∏è Revolt Risk:</strong> High portfolio concentration in similar investments means enterprise disruption could trigger portfolio-level crisis. Connectedness amplifies stress transmission upward.${shiftNote} Consider diversification or enhanced monitoring.`;
            }
            
            if (selectedShifts.some(s => s.includes('concentration'))) {
                return `<strong>Concentration Impact:</strong> ${selectedShifts.join('; ')}. Monitor how increased sector exposure affects portfolio-level resilience and cross-scale dynamics.`;
            }
            
            if (selectedShifts.some(s => s.includes('diversification'))) {
                return `<strong>Diversification Benefit:</strong> ${selectedShifts.join('; ')}. New sector exposure can reduce portfolio brittleness and improve adaptive capacity across scales.`;
            }
            
            if (analysisState.market.velocity > 70) {
                return `<strong>Remember Constraint:</strong> Rapid market changes may be constrained by portfolio's slower adaptation capacity. Portfolio phase and structure limits how quickly capital can respond to market opportunities.`;
            }
            
            if (selectedShifts.length > 0) {
                return `<strong>Portfolio Dynamics:</strong> ${selectedShifts.join('; ')}. Assess how these shifts affect cross-scale resilience and phase relationships.`;
            }
            
            return `<strong>Moderate Coupling:</strong> Cross-scale connections are present but not extreme. Enterprise has some autonomy within portfolio context; portfolio has some flexibility relative to market dynamics.`;
        }

        function generateTransitionInsight() {
            const timeInPhase = parseInt(analysisState.enterprise.timeInPhase) || 0;
            const resilience = parseInt(analysisState.enterprise.resilience);
            const connectedness = parseInt(analysisState.enterprise.connectedness);
            
            // Get selected transition signals
            const transitionSelect = document.getElementById('transitionSignals');
            const selectedSignals = transitionSelect ? Array.from(transitionSelect.selectedOptions).map(opt => opt.text) : [];
            
            let probability = 'Low';
            let timeframe = 'years';
            
            // Adjust probability based on signals
            const signalCount = selectedSignals.length;
            
            if (timeInPhase > 24 || signalCount >= 4) {
                probability = 'High';
                timeframe = 'months';
            } else if (timeInPhase > 12 || signalCount >= 2) {
                probability = 'Moderate';
                timeframe = '12-18 months';
            }
            
            let brittlenessNote = '';
            if (analysisState.enterprise.phase === 'K' && connectedness > 70 && resilience < 40) {
                brittlenessNote = ' <strong>‚ö†Ô∏è Warning:</strong> High connectedness with low resilience signals potential for rapid collapse rather than smooth transition.';
            }
            
            let signalsList = '';
            if (selectedSignals.length > 0) {
                signalsList = `<br><strong>Active signals:</strong> ${selectedSignals.join(', ')}.`;
            }
            
            return `<strong>${probability} probability</strong> of phase transition within ${timeframe}. Enterprise has been in current phase for ${timeInPhase} months.${signalsList}${brittlenessNote} Capital should prepare adaptive provisions now.`;
        }

        function calculateRRIField() {
            const { enterprise, portfolio, market } = analysisState;
            
            // Risk calculation based on phase relationships
            let riskLevel = 'Moderate';
            let riskValue = 'Dynamic';
            
            if (enterprise.phase === 'omega' || market.phase === 'omega') {
                riskLevel = 'High';
                riskValue = 'Bifurcating';
            } else if (enterprise.phase === 'r' || enterprise.phase === 'alpha') {
                riskLevel = 'Distributed';
                riskValue = 'Multi-pathway';
            } else if (enterprise.phase === 'K' && parseInt(enterprise.resilience) < 40) {
                riskLevel = 'Hidden High';
                riskValue = 'Brittle';
            }
            
            // Return calculation
            let returnValue = 'Phase-dependent';
            if (enterprise.phase === 'K' && market.phase === 'r') {
                returnValue = 'Optimizing';
            } else if (enterprise.phase === 'alpha') {
                returnValue = 'Catalytic';
            } else if (enterprise.phase === 'omega') {
                returnValue = 'Option Value';
            }
            
            // Impact calculation
            let impactValue = 'Co-creative';
            if (enterprise.phase === 'K') {
                impactValue = 'Scaling';
            } else if (enterprise.phase === 'alpha') {
                impactValue = 'Emergent';
            } else if (enterprise.phase === 'omega') {
                impactValue = 'Preserving';
            }
            
            // Transformation description
            const transformation = generateRRITransformation();
            
            return {
                risk: riskValue,
                return: returnValue,
                impact: impactValue,
                transformation
            };
        }

        function generateRRITransformation() {
            const { enterprise, market } = analysisState;
            
            if (enterprise.phase === 'r') {
                return `As enterprise cycles into K-phase: Risk will appear to decrease (stability) but actually increase (brittleness). Returns will optimize and stabilize. Impact will scale but may lose adaptability. All three transform together‚Äîcannot isolate one.`;
            }
            
            if (enterprise.phase === 'K') {
                return `Approaching Œ©-phase transition: Risk will spike dramatically as brittleness reveals itself. Returns may disappear temporarily but option value increases. Impact metrics will destabilize but transformative potential emerges. The field is about to undergo phase transition.`;
            }
            
            if (enterprise.phase === 'omega') {
                return `During Œ©-phase: Risk bifurcates into collapse vs. transformation pathways. Returns become non-linear and highly sensitive to small interventions. Impact focuses on core preservation vs. total loss. The field is in superposition‚Äîmultiple futures possible.`;
            }
            
            if (enterprise.phase === 'alpha') {
                return `In Œ±-phase reorganization: Risk distributes across experiments‚Äîportfolio within investment. Returns become catalytic‚Äîsmall capital generating large leverage. Impact enables emergence of novel structures. Field is most fluid and adaptive.`;
            }
            
            return `Risk, return, and impact are entangled and transforming together as the system moves through its cycle.`;
        }

        function determineCapitalBehavior() {
            const { enterprise, portfolio, market } = analysisState;
            
            let behavior = '';
            
            // Current phase behavior
            behavior += `
                <div class="behavior-phase">
                    <div class="behavior-phase-name">Current Phase: ${getPhaseFullName(enterprise.phase)}</div>
                    <div class="behavior-phase-action">${getCurrentPhaseBehavior(enterprise.phase)}</div>
                    <div class="behavior-terms">${getCurrentPhaseTerms(enterprise.phase)}</div>
                </div>
            `;
            
            // Next likely phase behavior
            const nextPhase = getNextPhase(enterprise.phase);
            behavior += `
                <div class="behavior-phase">
                    <div class="behavior-phase-name">Prepare for ${getPhaseFullName(nextPhase)}</div>
                    <div class="behavior-phase-action">${getPreparationBehavior(nextPhase)}</div>
                    <div class="behavior-terms">${getPreparationTerms(nextPhase)}</div>
                </div>
            `;
            
            // Cross-scale adjustments
            if (enterprise.phase !== market.phase) {
                behavior += `
                    <div class="behavior-phase">
                        <div class="behavior-phase-name">Cross-Scale Adjustment</div>
                        <div class="behavior-phase-action">${getCrossScaleBehavior()}</div>
                    </div>
                `;
            }
            
            return behavior;
        }

        function getCurrentPhaseBehavior(phase) {
            const behaviors = {
                'r': 'Support experimentation and exploration. Capital should spread across multiple pathways, not force premature convergence. Accept high variance in outcomes as healthy. Focus on building adaptive capacity.',
                'K': 'Optimize for efficiency and scale. Capital structure should emphasize stability, predictable returns, operational excellence. But maintain vigilance for brittleness signals.',
                'omega': 'Provide patient, flexible support through disruption. Capital must distinguish between collapse pathway (requiring protection of core assets) vs. transformation pathway (requiring catalytic participation). Do not impose K-phase optimization during Œ©-phase crisis.',
                'alpha': 'Act as catalyst for reorganization. Small amounts of flexible capital can generate outsized impact. Enable recombination, novel partnerships, structural innovation. Terms should co-evolve with emerging structures.'
            };
            return behaviors[phase] || '';
        }

        function getCurrentPhaseTerms(phase) {
            const terms = {
                'r': 'Example terms: Revenue-based financing with floors/caps, milestone-based tranches enabling pivot, loose covenants permitting experimentation, longer time horizons (5-7 years)',
                'K': 'Example terms: Debt with standard covenants, equity with preferred returns, shorter time horizons (3-5 years), efficiency metrics in governance',
                'omega': 'Example terms: Payment holidays activated automatically, conversion options to participate in emergence, downside protection via guarantees, extreme patience (7-10 years)',
                'alpha': 'Example terms: Convertible notes capturing option value, success-based payments, governance rights that enable (not constrain) reorganization, medium horizons (4-6 years)'
            };
            return terms[phase] || '';
        }

        function getPreparationBehavior(phase) {
            return `Begin building provisions now for likely transition into ${getPhaseFullName(phase)} phase. ${getCurrentPhaseBehavior(phase)}`;
        }

        function getPreparationTerms(phase) {
            return `Embedded adaptive triggers: ${getCurrentPhaseTerms(phase)}`;
        }

        function getCrossScaleBehavior() {
            const { enterprise, market } = analysisState;
            
            if (enterprise.phase === 'K' && market.phase === 'omega') {
                return 'Market disruption while enterprise optimizes‚ÄîCRITICAL MISMATCH. Capital must immediately create flexibility provisions, build liquidity buffers, prepare for forced adaptation. Consider embedding automatic transition to Œ©-phase terms if market indicators worsen.';
            }
            
            if (enterprise.phase === 'r' && market.phase === 'omega') {
                return 'Enterprise flexibility during market disruption‚ÄîOPPORTUNITY. Capital should be bold but patient, enabling enterprise to capture opportunities others cannot. This is when adaptive capacity generates asymmetric returns.';
            }
            
            return 'Monitor cross-scale phase differences. Adjust capital behavior to bridge phase mismatches rather than ignoring them.';
        }

        function identifyBifurcations() {
            const { enterprise, market } = analysisState;
            const bifurcationSelect = document.getElementById('bifurcation');
            const selectedOptions = bifurcationSelect ? Array.from(bifurcationSelect.selectedOptions).map(opt => opt.text) : [];
            
            let pathways = '';
            
            if (enterprise.phase === 'omega' || market.phase === 'omega') {
                pathways += `
                    <div class="pathway">
                        <div class="pathway-name">Pathway A: Transformation</div>
                        <div class="pathway-probability">Probability: ${enterprise.resilience > 50 ? 'Moderate-High (40-60%)' : 'Low-Moderate (20-40%)'}</div>
                        <div class="pathway-description">
                            Enterprise successfully navigates disruption, emerges reorganized with new capabilities. Market transition enables new positioning. Capital participates in upside through conversion options and success-based payments.
                        </div>
                    </div>
                    <div class="pathway">
                        <div class="pathway-name">Pathway B: Decline</div>
                        <div class="pathway-probability">Probability: ${enterprise.resilience < 40 ? 'Moderate-High (40-60%)' : 'Low-Moderate (20-40%)'}</div>
                        <div class="pathway-description">
                            Enterprise cannot adapt quickly enough, enters terminal decline. Capital focuses on core asset preservation, orderly wind-down, salvage value recovery. Loss mitigation priority.
                        </div>
                    </div>
                    <div class="pathway">
                        <div class="pathway-name">Capital Strategy</div>
                        <div class="pathway-description">
                            Structure capital to protect downside in Pathway B while maintaining participation rights in Pathway A. Use tranched structure: senior tranche with asset security, junior tranche with equity-like upside. Monitor bifurcation indicators monthly.
                        </div>
                    </div>
                `;
            } else if (selectedOptions.length > 0) {
                pathways += `
                    <div class="pathway">
                        <div class="pathway-name">Market-Level Bifurcation Detected</div>
                        <div class="pathway-description">
                            Multiple futures emerging: ${selectedOptions.join('; ')}
                        </div>
                    </div>
                    <div class="pathway">
                        <div class="pathway-name">Capital Strategy</div>
                        <div class="pathway-description">
                            Position enterprise to succeed in multiple possible futures. Avoid over-optimization to single scenario. Maintain strategic flexibility and adaptive capacity. Consider how capital structure enables or constrains pivots between pathways.
                        </div>
                    </div>
                `;
            } else {
                pathways += `
                    <div class="pathway">
                        <div class="pathway-name">No Immediate Bifurcation</div>
                        <div class="pathway-description">
                            Current system state does not show strong bifurcation signals. Pathway forward appears relatively clear, though this can change as system moves through cycle. Continue monitoring for emergence of multiple possible futures.
                        </div>
                    </div>
                `;
            }
            
            return pathways;
        }

        function generateDynamicsMatrix() {
            const { enterprise, portfolio, market } = analysisState;
            
            // Calculate phase differences
            const entPhase = enterprise.phase;
            const portPhase = portfolio.phase;
            const mktPhase = market.phase;
            
            // Get more detailed interaction assessment
            const entPort = getDetailedInteraction(entPhase, enterprise.cyclePosition, portPhase, portfolio.cyclePosition);
            const entMkt = getDetailedInteraction(entPhase, enterprise.cyclePosition, mktPhase, market.cyclePosition);
            const portMkt = getDetailedInteraction(portPhase, portfolio.cyclePosition, mktPhase, market.cyclePosition);
            
            return `
                <div class="dynamics-cell header"></div>
                <div class="dynamics-cell header">Portfolio<br>${getPhaseFullName(portPhase)}<br>${Math.round(portfolio.cyclePosition)}¬∞</div>
                <div class="dynamics-cell header">Market<br>${getPhaseFullName(mktPhase)}<br>${Math.round(market.cyclePosition)}¬∞</div>
                
                <div class="dynamics-cell label">Enterprise<br>${getPhaseFullName(entPhase)}<br>${Math.round(enterprise.cyclePosition)}¬∞</div>
                <div class="dynamics-cell ${entPort.class}" style="padding: 8px;">
                    <div style="font-weight: 700; margin-bottom: 4px;">${entPort.icon} ${entPort.label}</div>
                    <div style="font-size: 10px; line-height: 1.3;">${entPort.description}</div>
                </div>
                <div class="dynamics-cell ${entMkt.class}" style="padding: 8px;">
                    <div style="font-weight: 700; margin-bottom: 4px;">${entMkt.icon} ${entMkt.label}</div>
                    <div style="font-size: 10px; line-height: 1.3;">${entMkt.description}</div>
                </div>
                
                <div class="dynamics-cell label">Portfolio<br>${getPhaseFullName(portPhase)}<br>${Math.round(portfolio.cyclePosition)}¬∞</div>
                <div class="dynamics-cell" style="background: #1a1f3a; font-size: 11px; color: #666;">Self</div>
                <div class="dynamics-cell ${portMkt.class}" style="padding: 8px;">
                    <div style="font-weight: 700; margin-bottom: 4px;">${portMkt.icon} ${portMkt.label}</div>
                    <div style="font-size: 10px; line-height: 1.3;">${portMkt.description}</div>
                </div>
            `;
        }

        function getDetailedInteraction(phase1, pos1, phase2, pos2) {
            // Calculate phase difference in degrees
            const diff = Math.abs(pos1 - pos2);
            const normalizedDiff = Math.min(diff, 360 - diff); // Get shortest distance around cycle
            
            // Base interaction patterns
            if (normalizedDiff < 30) {
                // Highly aligned - same position
                return {
                    icon: '‚ú®',
                    label: 'Resonance',
                    description: 'Systems moving in sync. Amplification of dynamics - opportunities and risks magnified.',
                    class: 'synergy'
                };
            } else if (normalizedDiff > 150 && normalizedDiff < 210) {
                // Opposition - 180¬∞ apart
                if ((phase1 === 'K' && phase2 === 'omega') || (phase1 === 'omega' && phase2 === 'K')) {
                    return {
                        icon: '‚ö†Ô∏è',
                        label: 'Critical Tension',
                        description: 'Optimization meeting disruption. High risk of forced adaptation or failure.',
                        class: 'tension'
                    };
                } else if ((phase1 === 'r' && phase2 === 'omega') || (phase1 === 'omega' && phase2 === 'r')) {
                    return {
                        icon: 'üîÑ',
                        label: 'Transformation Window',
                        description: 'Flexibility meeting disruption. Opportunity for adaptive advantage.',
                        class: 'synergy'
                    };
                } else {
                    return {
                        icon: '‚ÜîÔ∏è',
                        label: 'Phase Opposition',
                        description: 'Systems in opposite cycles. Requires careful navigation of conflicting dynamics.',
                        class: 'tension'
                    };
                }
            } else if (normalizedDiff > 75 && normalizedDiff < 105) {
                // Quadrature - 90¬∞ apart
                return {
                    icon: '‚üÇ',
                    label: 'Orthogonal',
                    description: 'Systems in different phases. Independent dynamics with some friction.',
                    class: ''
                };
            } else if (phase1 === phase2) {
                // Same phase but different positions within it
                if (phase1 === 'K') {
                    const laterInPhase = (pos1 % 90) > (pos2 % 90);
                    return {
                        icon: '‚è©',
                        label: laterInPhase ? 'Leading K' : 'Following K',
                        description: laterInPhase ? 'More optimized, potentially more brittle.' : 'Still building optimization, more flexibility.',
                        class: ''
                    };
                } else if (phase1 === 'omega') {
                    return {
                        icon: 'üåä',
                        label: 'Shared Disruption',
                        description: 'Both experiencing release phase. Cascading effects likely.',
                        class: 'tension'
                    };
                } else if (phase1 === 'alpha') {
                    return {
                        icon: 'üîÄ',
                        label: 'Co-Reorganization',
                        description: 'Both exploring new structures. Potential for novel alignments.',
                        class: 'synergy'
                    };
                } else {
                    return {
                        icon: '‚ÜóÔ∏è',
                        label: 'Parallel Growth',
                        description: 'Both in exploration mode. Opportunities for mutual learning.',
                        class: 'synergy'
                    };
                }
            } else {
                // Different phases, moderate distance
                const phaseDistance = getPhaseDistance(phase1, phase2);
                if (phaseDistance === 1) {
                    return {
                        icon: '‚Üí',
                        label: 'Adjacent Phases',
                        description: 'One phase ahead/behind. Natural progression or lag pattern.',
                        class: ''
                    };
                } else if (phaseDistance === 2) {
                    return {
                        icon: '‚§¥Ô∏è',
                        label: 'Phase Skip',
                        description: 'Two phases apart. Significant adaptation needed for alignment.',
                        class: ''
                    };
                }
            }
            
            return {
                icon: '‚óã',
                label: 'Mixed',
                description: 'Complex interaction requiring nuanced analysis.',
                class: ''
            };
        }

        function getPhaseDistance(phase1, phase2) {
            const phaseOrder = { 'r': 0, 'K': 1, 'omega': 2, 'alpha': 3 };
            const p1 = phaseOrder[phase1];
            const p2 = phaseOrder[phase2];
            const diff = Math.abs(p1 - p2);
            return Math.min(diff, 4 - diff); // Circular distance
        }

        function assessCrossScaleDynamics() {
            // Placeholder for more sophisticated dynamics assessment
            return {};
        }

        function getNextPhase(phase) {
            const cycle = { 'r': 'K', 'K': 'omega', 'omega': 'alpha', 'alpha': 'r' };
            return cycle[phase] || 'r';
        }

        function getPhaseFullName(phase) {
            const names = {
                'r': 'r - Growth',
                'K': 'K - Conservation',
                'omega': 'Œ© - Release',
                'alpha': 'Œ± - Reorganization'
            };
            return names[phase] || phase;
        }

        // Canvas visualization
        function drawPhaseRelationships() {
            const canvas = document.getElementById('phaseCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Draw three separate infinity loops at different positions
            // Sizes now reflect nested hierarchy: Market (largest) > Portfolio (medium) > Enterprise (smallest)
            // Enterprise: 60, Portfolio: 90 (50% larger), Market: 135 (50% larger than portfolio)
            drawInfinityLoop(ctx, centerX - 250, centerY - 50, 135, getPhaseColor(analysisState.market.phase), 'CDN IMPACT-FINANCE MARKET', 3.5, analysisState.market.phase, analysisState.market.cyclePosition);
            drawInfinityLoop(ctx, centerX, centerY, 90, getPhaseColor(analysisState.portfolio.phase), 'BOANN PORTFOLIO', 3, analysisState.portfolio.phase, analysisState.portfolio.cyclePosition);
            drawInfinityLoop(ctx, centerX + 250, centerY + 50, 60, getPhaseColor(analysisState.enterprise.phase), 'SFI', 2.5, analysisState.enterprise.phase, analysisState.enterprise.cyclePosition);
            
            // Draw connecting lines showing relationships
            ctx.strokeStyle = 'rgba(102, 126, 234, 0.3)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            
            ctx.beginPath();
            ctx.moveTo(centerX - 115, centerY - 50);
            ctx.lineTo(centerX - 90, centerY);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(centerX + 90, centerY);
            ctx.lineTo(centerX + 190, centerY + 50);
            ctx.stroke();
            
            ctx.setLineDash([]);
            
            // Add phase difference annotations
            drawPhaseDifferenceAnnotations(ctx, centerX, centerY);
        }

        function drawPhaseDifferenceAnnotations(ctx, centerX, centerY) {
            const { enterprise, portfolio, market } = analysisState;
            
            // Calculate phase differences
            const entPortDiff = Math.abs(enterprise.cyclePosition - portfolio.cyclePosition);
            const portMktDiff = Math.abs(portfolio.cyclePosition - market.cyclePosition);
            
            // Show tension indicators if phases are significantly misaligned
            ctx.font = '11px -apple-system, sans-serif';
            
            if (entPortDiff > 90 && entPortDiff < 270) {
                ctx.fillStyle = '#e74c3c';
                ctx.fillText('‚ö† Phase Tension', centerX + 80, centerY + 25);
            }
            
            if (portMktDiff > 90 && portMktDiff < 270) {
                ctx.fillStyle = '#e74c3c';
                ctx.fillText('‚ö† Scale Mismatch', centerX - 140, centerY - 25);
            }
        }

        function drawInfinityLoop(ctx, cx, cy, size, color, label, lineWidth, phase, cyclePosition) {
            ctx.strokeStyle = color;
            ctx.lineWidth = lineWidth;
            ctx.globalAlpha = 0.7;
            
            // Draw infinity loop
            ctx.beginPath();
            for (let t = 0; t < Math.PI * 2; t += 0.01) {
                const x = cx + size * Math.cos(t) / (1 + Math.sin(t) * Math.sin(t));
                const y = cy + size * Math.sin(t) * Math.cos(t) / (1 + Math.sin(t) * Math.sin(t));
                if (t === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();
            
            // Draw current position marker using precise position if available
            const pos = cyclePosition !== undefined 
                ? (cyclePosition * Math.PI / 180) 
                : getPhasePosition(phase);
            const markerX = cx + size * Math.cos(pos) / (1 + Math.sin(pos) * Math.sin(pos));
            const markerY = cy + size * Math.sin(pos) * Math.cos(pos) / (1 + Math.sin(pos) * Math.sin(pos));
            
            ctx.fillStyle = color;
            ctx.globalAlpha = 1;
            ctx.beginPath();
            ctx.arc(markerX, markerY, 8, 0, Math.PI * 2);
            ctx.fill();
            
            // Add a white ring around the marker for better visibility
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(markerX, markerY, 8, 0, Math.PI * 2);
            ctx.stroke();
            
            // Center label above the cycle
            ctx.font = 'bold 14px -apple-system, sans-serif';
            ctx.fillStyle = color;
            ctx.textAlign = 'center';
            ctx.fillText(label, cx, cy - size - 25);
            
            // Phase name below label
            ctx.font = '12px -apple-system, sans-serif';
            ctx.fillText(getPhaseFullName(phase), cx, cy - size - 10);
            
            // Show precise position
            if (cyclePosition !== undefined) {
                ctx.font = '11px -apple-system, sans-serif';
                ctx.fillStyle = '#888';
                ctx.fillText(`${cyclePosition}¬∞`, cx, cy - size + 5);
            }
            
            // Reset text alignment
            ctx.textAlign = 'left';
        }

        function getPhaseColor(phase) {
            const colors = {
                'r': '#1abc9c',
                'K': '#3498db',
                'omega': '#e74c3c',
                'alpha': '#f1c40f'
            };
            return colors[phase] || '#667eea';
        }

        function getPhasePosition(phase) {
            const positions = {
                'r': 0,
                'K': Math.PI / 2,
                'omega': Math.PI,
                'alpha': Math.PI * 1.5
            };
            return positions[phase] || 0;
        }

        function updateCrossScaleAnalysis() {
            // Update phase alignment insight
            const alignmentElement = document.querySelector('.insight-card:nth-child(2) .insight-content');
            if (alignmentElement) {
                alignmentElement.innerHTML = generateAlignmentInsight();
            }
            
            // Update cross-scale forces insight
            const crossScaleElement = document.querySelector('.insight-card:nth-child(3) .insight-content');
            if (crossScaleElement) {
                crossScaleElement.innerHTML = generateCrossScaleInsight();
            }

            // Calculate and display phase differences
            const { enterprise, portfolio, market } = analysisState;
            const entPortDiff = Math.abs(enterprise.cyclePosition - portfolio.cyclePosition);
            const portMktDiff = Math.abs(portfolio.cyclePosition - market.cyclePosition);
            const entMktDiff = Math.abs(enterprise.cyclePosition - market.cyclePosition);
            
            console.log('Phase differences:', { entPortDiff, portMktDiff, entMktDiff });
        }

        function updateCapitalBehavior() {
            const capitalBehaviorElement = document.querySelector('.capital-behavior .behavior-timeline');
            if (capitalBehaviorElement) {
                capitalBehaviorElement.innerHTML = determineCapitalBehavior();
            }
        }

        function updateBifurcationAnalysis() {
            const bifurcationContainer = document.querySelector('.bifurcation-container');
            if (!bifurcationContainer) return;
            
            // Find all pathway divs and replace them
            const existingPathways = bifurcationContainer.querySelectorAll('.pathway');
            const newPathways = identifyBifurcations();
            
            // Create temp container to parse HTML
            const temp = document.createElement('div');
            temp.innerHTML = newPathways;
            
            // Remove old pathways
            existingPathways.forEach(p => p.remove());
            
            // Add new pathways
            temp.querySelectorAll('.pathway').forEach(pathway => {
                bifurcationContainer.appendChild(pathway);
            });
        }

        function updateRRIField() {
            const rriField = calculateRRIField();
            
            // Update the dimension values
            const riskElement = document.querySelector('.rri-dimension:nth-child(1) .rri-dimension-value');
            const returnElement = document.querySelector('.rri-dimension:nth-child(2) .rri-dimension-value');
            const impactElement = document.querySelector('.rri-dimension:nth-child(3) .rri-dimension-value');
            
            if (riskElement) riskElement.textContent = rriField.risk;
            if (returnElement) returnElement.textContent = rriField.return;
            if (impactElement) impactElement.textContent = rriField.impact;
            
            // Update the transformation text
            const transformationElement = document.querySelector('.rri-transformation-text');
            if (transformationElement) {
                transformationElement.textContent = rriField.transformation;
            }
        }

        function updateDynamicsMatrix() {
            const matrixContainer = document.querySelector('.dynamics-matrix');
            if (!matrixContainer) return;
            
            const matrixContent = matrixContainer.querySelector('.dynamics-grid');
            if (!matrixContent) return;
            
            const newMatrix = generateDynamicsMatrix();
            matrixContent.innerHTML = newMatrix;
        }

        // Dynamic insight updates as cycle position changes
        function updateDynamicInsights() {
            const position = analysisState.enterprise.cyclePosition;
            
            // Determine sub-phase within the current phase
            let subPhase = '';
            let capitalGuidance = '';
            
            if (position >= 0 && position < 90) {
                // r phase
                const progress = position / 90;
                if (progress < 0.33) {
                    subPhase = 'Early r-phase: Maximum exploration';
                    capitalGuidance = 'Encourage wide experimentation, multiple bets, high variance. Avoid forcing convergence.';
                } else if (progress < 0.66) {
                    subPhase = 'Mid r-phase: Learning acceleration';
                    capitalGuidance = 'Support rapid learning cycles, adaptive pivots. Begin identifying patterns in successes.';
                } else {
                    subPhase = 'Late r-phase: Emerging structures';
                    capitalGuidance = 'Prepare for K transition. Start building optimization capabilities while maintaining flexibility.';
                }
            } else if (position >= 90 && position < 180) {
                // K phase
                const progress = (position - 90) / 90;
                if (progress < 0.33) {
                    subPhase = 'Early K-phase: Efficiency building';
                    capitalGuidance = 'Invest in optimization, scale proven models. Returns should stabilize and increase.';
                } else if (progress < 0.66) {
                    subPhase = 'Mid K-phase: Peak optimization';
                    capitalGuidance = 'Maximum efficiency, stable returns. But monitor brittleness‚Äîhigh connectedness = fragility.';
                } else {
                    subPhase = 'Late K-phase: Brittleness warning';
                    capitalGuidance = 'CRITICAL: System may be over-optimized. Build liquidity buffers, prepare for disruption. Brittleness is HIGH.';
                }
            } else if (position >= 180 && position < 270) {
                // Œ© phase
                const progress = (position - 180) / 90;
                if (progress < 0.33) {
                    subPhase = 'Early Œ©-phase: Disruption onset';
                    capitalGuidance = 'Shift to pure patience. Suspend optimization demands. Protect core capabilities. Bifurcation approaching.';
                } else if (progress < 0.66) {
                    subPhase = 'Mid Œ©-phase: Bifurcation point';
                    capitalGuidance = 'BIFURCATION ACTIVE: Multiple futures visible. Capital must choose: support transformation or manage decline.';
                } else {
                    subPhase = 'Late Œ©-phase: Release completing';
                    capitalGuidance = 'Prepare for Œ± emergence. If transforming: position for catalytic participation. If declining: orderly exit.';
                }
            } else {
                // Œ± phase
                const progress = (position - 270) / 90;
                if (progress < 0.33) {
                    subPhase = 'Early Œ±-phase: Reorganization begins';
                    capitalGuidance = 'Enable recombination, novel partnerships, structural innovation. Small capital = large leverage.';
                } else if (progress < 0.66) {
                    subPhase = 'Mid Œ±-phase: New structures forming';
                    capitalGuidance = 'Co-evolve terms with emerging structures. Support experimentation but with more direction than r-phase.';
                } else {
                    subPhase = 'Late Œ±-phase: Stabilization approaching';
                    capitalGuidance = 'New model crystallizing. Prepare for r-phase transition. Begin scaling what works.';
                }
            }
            
            // Update the insight card if it exists
            const phaseGuidanceElement = document.getElementById('subPhaseGuidance');
            if (phaseGuidanceElement) {
                phaseGuidanceElement.innerHTML = `
                    <div style="margin-bottom: 12px;">
                        <strong style="color: #667eea;">${subPhase}</strong>
                    </div>
                    <div style="font-size: 13px; color: #b0b0b0; line-height: 1.6;">
                        ${capitalGuidance}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>